<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Utilisateurs</title>
  <script src="https://cdn.tailwindcss.com"></script>

</head>

<body class="bg-gray-100 font-sans">

<div class="flex h-screen">

  <aside th:replace="fragments/side_bar :: aside"></aside>
  <main class="bg-white rounded-l-lg shadow-lg w-full col-span-11 flex flex-col h-screen">
    <nav th:replace="fragments/nav :: nav"></nav>
    <div class="p-6 flex justify-between items-center">
      <!-- Search Bar -->
      <form id="searchForm" th:action="@{/Admin/search}" method="GET" class="flex gap-4 w-full">
        <!-- Search Bar -->
        <input
                id="searchInput"
                type="text"
                name="query"
                placeholder="Rechercher par nom ou email..."
                class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600 w-64"
        />
      </form>
      <!-- Filter Dropdown -->
      <select
              class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600"
      >
        <option value="">Filtrer par rôle</option>
        <option value="professeur">Professeur</option>
        <option value="admin">Admin</option>
        <option value="super admin">Super Admin</option>
      </select>
    </div>

    <!-- Header Section -->
    <div class="p-6 flex justify-between items-center">
      <div class="flex flex-col">
      <h2 class="text-xl font-semibold text-gray-800">Liste des Utilisateurs</h2>
        <div th:if="${action == true}" class="p-4 mt-2 text-sm text-green-800 rounded-lg bg-[#c9e8b9]"
             role="alert">
          <p th:if="${added != null}">
            Utilisateur <span class="font-bold" th:text="|'${added}'|"></span>
            ajouté avec succès
          </p>
          <p th:if="${deleted != null}">
            Utilisateur <span class="font-bold" th:text="|'${deleted}'|"></span>
            suprimé avec succès
          </p>
        </div>
      </div>
      <!-- Ajouter Utilisateur Button -->
      <label for="addUserModal" class="bg-[#313863] text-white py-2 px-6 rounded-lg hover:bg-blue-950 shadow-md cursor-pointer">
        + Ajouter Utilisateur
      </label>
    </div>
    <!-- User Table -->
    <section class="p-6 overflow-auto">
      <table class="w-full border-collapse border border-gray-200 shadow-sm rounded-lg overflow-hidden">
        <thead class="bg-[#b10c74] text-white">
        <tr>
          <th class="p-4 text-left"></th>
          <th class="p-4 text-left">Nom</th>
          <th class="p-4 text-left">Date de Naissance</th>
          <th class="p-4 text-left">Rôle</th>
          <th class="p-4 text-left">Email</th>
          <th class="p-4 text-center">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${users}" class="bg-gray-100 hover:bg-gray-200 transition-all">
          <td class="p-4 text-left">
            <button class="hover:opacity-80">
              <img src="/public/eye.png" alt="Voir" class="h-6 w-6">
            </button>
          </td>
          <td class="p-4" th:text="${user.nom + ' ' + user.prenom}"></td>
          <td class="p-4" th:text="${user.dateNaissance}"></td>
          <td class="p-4" th:text="${user.role.getAuthority()}"></td>
          <td class="p-4" th:text="${user.email}"></td>
          <td class="p-4 flex items-center justify-center gap-3">
            <button class="hover:opacity-80">
              <img src="/public/edit.png" alt="Modifier" class="h-6 w-6">
            </button>
            <form th:action="@{/users/{id}(id=${user.id})}" method="POST">
              <input type="hidden" name="_method" value="DELETE">
              <button type="submit" class="hover:opacity-80">
                <img src="/public/trash.png" alt="Delete" class="h-6 w-6">
              </button>
            </form>
          </td>
        </tr>
        </tbody>


      </table>
    </section>
  </main>
</div>

<!-- Modal -->
<input type="checkbox" id="addUserModal" class="peer hidden">
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden peer-checked:flex">
  <div class="w-full max-w-md max-h-[80vh] bg-[#f2eee7] p-6 rounded-lg shadow-lg overflow-hidden relative">
    <label for="addUserModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 cursor-pointer">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </label>
    <h2 class="text-lg font-semibold text-center text-gray-800 mb-6">
      Ajouter Un Nouvel Utilisateur
    </h2>
    <!-- User Registration Form -->
    <form method="POST" th:action="@{/users}" class="overflow-y-auto max-h-[60vh] pr-2">
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input name="nom" type="text" placeholder="Saisir Nom" class="p-2 w-full border rounded-md focus:outline-none" required>
        <input name="prenom" type="text" placeholder="Saisir Prénom" class="p-2 w-full border rounded-md focus:outline-none" required>
      </div>
      <div class="mb-4">
        <input name="email" type="email" placeholder="Saisir Email" class="p-2 w-full border rounded-md focus:outline-none" required>
      </div>
      <div class="mb-4">
        <input
                name="cin"
                type="text"
                placeholder="Saisir CIN"
                class="p-2 w-full border rounded-md focus:outline-none"
                required
                pattern="^[A-Za-z]{1,2}[0-9]{4,6}$"
                title="CIN must start with 1-2 letters followed by 4-6 digits."
        />
        <span id="cin-error" class="text-red-500 text-sm hidden">Invalid CIN format.</span>
      </div>
      <div class="mb-4 flex items-center gap-2">
        <span class="inline-block p-2 bg-red-100 text-red-600 rounded-md">+212</span>
        <input name="telephone" type="text" placeholder="Numéro de Téléphone" class="p-2 flex-1 border rounded-md focus:outline-none" required>
      </div>
      <div class="mb-4">
        <input name="adresse" type="text" placeholder="Saisir Adresse" class="p-2 w-full border rounded-md focus:outline-none" required>
      </div>
      <div class="mb-4">
        <select
                id="role-select"
                name="role"
                class="p-2 w-full border rounded-md focus:outline-none"
                required
        >
          <option value="" disabled selected>Choisir un rôle</option>
          <option value="ROLE_PROF">Professor</option>
          <option value="ROLE_ADMIN">Admin</option>
          <option value="ROLE_SS">Service de Scolarité</option>
          <option value="ROLE_SP">Service pédagogique</option>
        </select>
        <span id="role-error" class="text-red-500 text-sm hidden">Please select a role.</span>
      </div>
      <div class=" mb-4">
        <select  name="genre" class="p-2 w-full border rounded-md focus:outline-none">
          <option value="F">Femme</option>
          <option value="M">Homme</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="py-2 text-gray-900">Date de naissance</label>
        <input
                name="dateNaissance"
                type="date"
                max="2006-12-31"
                class="py-2 w-full border rounded-md focus:outline-none"
                required
        />
      </div>

      <!-- Additional Fields for Professors -->
      <div id="professor-fields" class="hidden">

        <div class="mb-4">
          <select  name="grade" class="p-2 w-full border rounded-md focus:outline-none">
            <option th:each="grade : ${grades}" th:value="${grade}" th:text="${grade}"></option>
          </select>
        </div>
        <div class="mb-4">
          <label  class="px-0 py-2 text-gray-900 ">Date Dernier Diplôme Obtenu</label>
          <input name="dateDernierDiplome" type="date" class="p-2 w-full border rounded-md focus:outline-none">
        </div>
        <div class="mb-4">
          <label  class="px-0 py-2 text-gray-900  ">Date D'ambauche</label>

          <input name="dateEmbauche" type="date" placeholder="Date d'Embauche" class="p-2 w-full border rounded-md focus:outline-none">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <!-- Password Field -->
        <div class="relative">
          <input
                  type="password"
                  name="password"
                  placeholder="Enter your password"
                  class="peer p-2 w-full border rounded-md focus:outline-none"
                  required
                  pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                  title="Password must be at least 8 characters long and include at least one uppercase letter, one lowercase letter, one number, and one special character (@$!%*?&)"
          />
          <p class="mt-1 text-cext-red-600 hidden peer-invalid:not(:placeholder-shown):block">
            Password must be at least 8 characters long and include at least one uppercase letter, one lowercase letter, one number, and one special character.
          </p>
        </div>

        <!-- Confirm Password Field -->
        <div class="relative">
          <input
                  name="confirmPassword"
                  type="password"
                  placeholder="Confirm your password"
                  class="peer p-2 w-full border rounded-md focus:outline-none"
                  required
          />
          <p class="mt-1 text-sm text-red-500 hidden peer-invalid:not(:placeholder-shown):block">
            Please confirm your password.
          </p>
        </div>
      </div>



      <div class="flex justify-between mt-6">
        <label for="addUserModal" class="px-4 py-2 text-white bg-[#b10c74] rounded-md hover:bg-pink-700 cursor-pointer">
          Annuler
        </label>
        <button type="submit" class="px-4 py-2 text-white bg-[#313863] rounded-md hover:bg-blue-900">
          Confirmer
        </button>
      </div>
    </form>
  </div>
</div>




<script>
  // Show/Hide professor-specific fields based on selected role
  document.getElementById("role-select").addEventListener("change", function () {
    const professorFields = document.getElementById("professor-fields");
    if (this.value === "ROLE_PROF") {
      professorFields.classList.remove("hidden");
    } else {
      professorFields.classList.add("hidden");
    }
  });


  // Get form, search input, and dropdown elements
  const searchForm = document.getElementById("searchForm");
  const searchInput = document.getElementById("searchInput");
  const roleDropdown = document.getElementById("roleDropdown");

  // Add event listener to the search input
  searchInput.addEventListener("input", function () {
    searchForm.submit(); // Submit the form whenever the user types
  });

  // Add event listener to the dropdown
  roleDropdown.addEventListener("change", function () {
    searchForm.submit(); // Submit the form whenever the dropdown value changes
  });
</script>


</body>
</html>